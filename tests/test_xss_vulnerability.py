
import pytest
import html
import json
import os
from src.core.export import HTMLReporter

def test_html_reporter_xss_protection(tmp_path):
    """Verify that HTMLReporter escapes user input to prevent XSS."""
    report_path = tmp_path / "report.html"
    reporter = HTMLReporter(output_path=str(report_path))

    xss_payload = "<script>alert('xss')</script>"
    project_name = f"Project {xss_payload}"
    results = {
        'issues': [
            {
                'id': f"RULE_{xss_payload}",
                'severity': 'high',
                'file': f"file_{xss_payload}.py",
                'line': 10,
                'message': f"Message {xss_payload}",
                'codebase_emissions': 0.0001
            }
        ],
        'codebase_emissions': 0.0001,
        'scanning_emissions': 0.0001,
        'per_file_emissions': {
            f"file_{xss_payload}.py": 0.0001
        }
    }

    reporter.export(results, project_name=project_name)

    with open(report_path, "r", encoding="utf-8") as f:
        content = f.read()

    # Check that the payload is escaped
    escaped_payload = html.escape(xss_payload)
    assert escaped_payload in content
    assert xss_payload not in content

    # Check that the chart data is JSON-encoded and escaped for script tag
    expected_json = json.dumps(list(results['per_file_emissions'].keys())).replace('<', '\\u003c').replace('>', '\\u003e')
    assert expected_json in content

def test_dashboard_contains_escape_function():
    """Verify that dashboard.html contains the escapeHTML function."""
    template_path = os.path.join("src", "ui", "templates", "dashboard.html")
    with open(template_path, 'r', encoding='utf-8') as f:
        content = f.read()

    assert "function escapeHTML(str)" in content
    # escapeHTML is still used in loadProjectsIntoModal and displayComparison
    assert "escapeHTML(project.name)" in content
    # escapeHTML(project.id) was removed from displayProjects (now uses DOM API)
    # assert "escapeHTML(project.id)" in content
    # JSON.stringify(project.name) was used in displayProjects onclick, but now removed.
    # It might be used in loadProjectsIntoModal?
    assert "JSON.stringify(arg || '')" in content # In loadProjectsIntoModal
    assert "escapeHTML(message)" in content
    assert "escapeHTML(error.message)" in content

def test_landing_page_uses_tojson_filter():
    """Verify that landing.html uses tojson | e filter for JS handlers."""
    template_path = os.path.join("src", "ui", "templates", "landing.html")
    with open(template_path, 'r', encoding='utf-8') as f:
        content = f.read()

    assert "project.name | tojson | e" in content

def test_dashboard_display_projects_security():
    """Verify that displayProjects uses DOM API instead of innerHTML for project list."""
    template_path = os.path.join("src", "ui", "templates", "dashboard.html")
    with open(template_path, 'r', encoding='utf-8') as f:
        content = f.read()

    # Assert that the vulnerable pattern is NOT present
    # The pattern from task description: onclick="viewProjectDetail('${project.name}')"
    assert "onclick=\"viewProjectDetail('${project.name}')\"" not in content

    # Assert that the old string-concatenation pattern is NOT present
    assert "onclick='viewProjectDetail(${onclickName})'" not in content

    # Assert that the secure DOM-based pattern IS present
    assert "document.createElement('div')" in content
    assert "textContent = project.name" in content
    assert "card.onclick = () => viewProjectDetail(project.name)" in content
