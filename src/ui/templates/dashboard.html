<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green AI Agent Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            /* Premium Modern Colorscheme - Inspired by Stripe, GitHub, Linear */
            --primary-color: #0ea5e9;
            --primary-dark: #0284c7;
            --primary-light: #38bdf8;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --critical-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;

            /* Sophisticated Grays */
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --card-darker: #0f172a;
            --text-light: #0f172a;
            --text-dark: #f1f5f9;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --overlay: rgba(15, 23, 42, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            line-height: 1.6;
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-dark);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .theme-toggle:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
        }

        body.dark-mode .theme-toggle {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 50px 40px;
            border-radius: 16px;
            margin-bottom: 40px;
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.15);
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.2);
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: var(--card-light);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 10px 30px rgba(14, 165, 233, 0.08);
            border: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode .metric-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 10px 30px rgba(14, 165, 233, 0.1);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(14, 165, 233, 0.12);
            border-color: var(--primary-light);
        }

        .metric-card h3 {
            margin: 0 0 16px 0;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 16px 0;
            letter-spacing: -0.5px;
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .metric-label {
            color: #94a3b8;
        }

        .issue {
            background: var(--card-light);
            border: 1px solid var(--border-light);
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        body.dark-mode .issue {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .issue:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateX(4px);
        }

        body.dark-mode .issue:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .severity-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid;
        }

        .severity-critical {
            background: rgba(239, 68, 68, 0.1);
            color: var(--critical-color);
            border-color: var(--critical-color);
        }

        body.dark-mode .severity-critical {
            background: rgba(239, 68, 68, 0.15);
            border-color: #fca5a5;
        }

        .severity-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--critical-color);
            border-color: var(--critical-color);
        }

        body.dark-mode .severity-high {
            background: rgba(239, 68, 68, 0.15);
            border-color: #fca5a5;
        }

        .severity-medium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border-color: #d97706;
        }

        body.dark-mode .severity-medium {
            background: rgba(245, 158, 11, 0.15);
            border-color: #fbbf24;
        }

        .severity-low {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        body.dark-mode .severity-low {
            background: rgba(59, 130, 246, 0.15);
            border-color: #93c5fd;
        }

        .insights {
            background: #ecfdf5;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        body.dark-mode .insights {
            background: #064e3b;
            border-left-color: #10b981;
        }

        .insights h4 {
            color: var(--primary-dark);
            margin-bottom: 12px;
            font-size: 16px;
        }

        body.dark-mode .insights h4 {
            color: #6ee7b7;
        }

        .insights ul {
            margin: 0;
            padding-left: 20px;
        }

        .insights li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .emissions-comparison,
        .runtime {
            background: var(--card-light);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border-top: 4px solid var(--primary-color);
        }

        body.dark-mode .emissions-comparison,
        body.dark-mode .runtime {
            background: var(--card-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .emissions-comparison h3,
        .runtime h3,
        .issues-container h3 {
            color: var(--primary-dark);
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .issues-container {
            background: var(--card-light);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--primary-color);
        }

        body.dark-mode .issues-container {
            background: var(--card-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            background: var(--border-light);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }

        body.dark-mode .progress-bar {
            background: var(--border-dark);
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .tag {
            display: inline-block;
            background: var(--border-light);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            margin-right: 8px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        body.dark-mode .tag {
            background: var(--border-dark);
        }

        .success-message {
            background: #dcfce7;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            color: #166534;
            font-weight: 600;
        }

        body.dark-mode .success-message {
            background: #064e3b;
            color: #86efac;
        }

        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .metrics-container {
                grid-template-columns: 1fr;
            }

            .metric-card {
                padding: 20px;
            }

            .metric-value {
                font-size: 24px;
            }
        }

        code {
            background: var(--border-light);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        body.dark-mode code {
            background: var(--border-dark);
        }

        /* ===== SONARQUBE-STYLE UI ENHANCEMENTS ===== */

        /* Project Header Section */
        .project-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 40px 50px;
            border-radius: 16px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.15);
        }

        body.dark-mode .project-header {
            background: linear-gradient(135deg, #0369a1 0%, #06b6d4 100%);
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.1);
        }

        .project-info {
            flex: 1;
        }

        .project-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-metadata {
            display: flex;
            gap: 20px;
            font-size: 13px;
            opacity: 0.95;
            flex-wrap: wrap;
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .project-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-color);
            border: 1.5px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: rgba(14, 165, 233, 0.2);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--critical-color);
            border: 1.5px solid var(--critical-color);
        }

        .btn-danger:hover {
            background: var(--critical-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Project Selector */
        .project-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .project-selector select {
            padding: 10px 15px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--card-light);
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
            min-width: 300px;
        }

        body.dark-mode .project-selector select {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .project-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Enhanced Modal/Form Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-light);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .modal-content {
            background: var(--card-dark);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .modal-header {
            border-bottom-color: var(--border-dark);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-light);
        }

        body.dark-mode .modal-header h2 {
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            color: var(--primary-color);
            background: rgba(14, 165, 233, 0.1);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-light);
        }

        body.dark-mode .form-group label {
            color: #cbd5e1;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-light);
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group textarea,
        body.dark-mode .form-group select {
            background: #4b5563;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        border-color: var(--border-dark);
        color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-help {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        body.dark-mode .form-help {
            color: #9ca3af;
        }

        /* Tab System Styles */
        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 0;
        }

        body.dark-mode .tabs-container {
            border-bottom-color: var(--border-dark);
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .tab-button {
            color: #9ca3af;
        }

        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(14, 165, 233, 0.05);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Projects View Styles */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
        }

        .search-filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input,
        .sort-select {
            padding: 10px 15px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--card-light);
            color: var(--text-light);
            font-size: 14px;
        }

        body.dark-mode .search-input,
        body.dark-mode .sort-select {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .search-input:focus,
        .sort-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .project-card {
            background: var(--card-light);
            border: 1.5px solid var(--border-light);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .project-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(14, 165, 233, 0.15);
            border-color: var(--primary-color);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 16px;
        }

        .project-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-light);
        }

        body.dark-mode .project-name {
            color: var(--text-dark);
        }

        .project-language {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            white-space: nowrap;
        }

        .grade-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: 700;
            background: var(--border-light);
            color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .grade-badge {
            background: var(--border-dark);
        }

        .grade-a {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #065f46;
        }

        .grade-b {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #78350f;
        }

        .grade-c {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            color: #7c2d12;
        }

        .grade-d {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
        }

        .grade-f {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
        }

        .project-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
            padding: 16px 0;
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .project-meta {
            border-color: var(--border-dark);
        }

        .meta-item {
            font-size: 12px;
        }

        .meta-label {
            color: #6b7280;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        body.dark-mode .meta-label {
            color: #9ca3af;
        }

        .meta-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .meta-value {
            color: var(--text-dark);
        }

        .violations-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .violation-badge {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        .violation-high {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .violation-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .violation-low {
            background: #dbeafe;
            color: #1e40af;
        }

        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-small:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Comparison View */
        .comparison-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 200px repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: var(--card-light);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            align-items: center;
        }

        body.dark-mode .comparison-row {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .comparison-header {
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            font-size: 12px;
        }

        body.dark-mode .comparison-header {
            color: #9ca3af;
        }

        .comparison-value {
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .comparison-value {
            color: var(--text-dark);
        }
    </style>
</head>

<body>
    <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">üåô</button>
    <div class="header">
        <h1>üå± Green AI Agent Dashboard</h1>
        <p>Comprehensive Codebase Carbon Footprint Analysis & Optimization</p>
    </div>

    <!-- Project Header Section -->
    <div class="project-header">
        <div class="project-info">
            <div class="project-title">
                <span>üìÅ Current Project</span>
                <span id="current-project-name" style="color: #fff;">Local Scan</span>
            </div>
            <div class="project-metadata">
                <div class="metadata-item">
                    <span>üìç</span>
                    <span id="current-project-url">No project selected</span>
                </div>
                <div class="metadata-item">
                    <span>‚è±Ô∏è</span>
                    <span id="current-project-time">Never scanned</span>
                </div>
                <div class="metadata-item">
                    <span id="current-project-grade-icon">‚Ä¢</span>
                    <span id="current-project-grade">N/A</span>
                </div>
            </div>
        </div>
        <div class="project-controls">
            <button class="btn btn-primary" onclick="openScanModal()" title="Scan new code">
                + New Scan
            </button>
            <button class="btn btn-secondary" onclick="openProjectList()" title="Switch projects">
                Switch Project
            </button>
            <button class="btn btn-secondary" onclick="refreshCurrentProject()" title="Refresh data">
                üîÑ Refresh
            </button>
            <button class="btn btn-secondary" onclick="calibrateSystem()" title="Calibrate system for accurate emissions">
                ‚öñÔ∏è Calibrate
            </button>
        </div>
    </div>

    <!-- Scan Modal -->
    <div id="scanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç New Code Scan</h2>
                <button class="modal-close" onclick="closeScanModal()">&times;</button>
            </div>
            <form onsubmit="submitScan(event)">
                <div class="form-group">
                    <label for="scan-project-name">Project Name *</label>
                    <input type="text" id="scan-project-name" placeholder="e.g., MyApp Backend" required>
                    <div class="form-help">Unique identifier for this project</div>
                </div>

                <div class="form-group">
                    <label for="scan-language">Language *</label>
                    <select id="scan-language" required>
                        <option value="">Select language...</option>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="java">Java</option>
                        <option value="csharp">C#</option>
                        <option value="cpp">C++</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Code Source *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="toggleScanMode('local')"
                            id="mode-local" style="background: var(--primary-color); color: white;">üìÅ Local
                            Path</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleScanMode('git')" id="mode-git">üîó
                            Git URL</button>
                    </div>
                </div>

                <div id="local-scan-input" class="form-group">
                    <label for="scan-path">Directory Path *</label>
                    <input type="text" id="scan-path" placeholder="/path/to/code" required>
                    <div class="form-help">Local filesystem path to scan</div>
                </div>

                <div id="git-scan-input" class="form-group" style="display: none;">
                    <label for="scan-url">Git URL *</label>
                    <input type="text" id="scan-url" placeholder="https://github.com/user/repo.git">
                    <div class="form-help">HTTPS or SSH URL (supports @branch syntax)</div>
                </div>

                <div id="git-branch-input" class="form-group" style="display: none;">
                    <label for="scan-branch">Branch (Optional)</label>
                    <input type="text" id="scan-branch" placeholder="main">
                    <div class="form-help">Leave empty for default branch</div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary"
                        style="flex: 1; background: var(--primary-color); color: white; border: none;">
                        üöÄ Start Scan
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeScanModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Management Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÇ Select Project</h2>
                <button class="modal-close" onclick="closeProjectModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Your Projects:</label>
                <div id="projects-list-modal" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280; padding: 40px 20px;">Loading projects...</p>
                </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="closeProjectModal()"
                style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- Remediation Preview Modal -->
    <div id="remediationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üõ†Ô∏è Remediation Preview</h2>
                <button class="modal-close" onclick="closeRemediationModal()">&times;</button>
            </div>
            <div id="remediation-content">
                <p id="remediation-desc" style="margin-bottom: 20px; font-weight: 500; color: var(--text-muted);"></p>
                <div
                    style="background: #0f172a; color: #f8fafc; padding: 20px; border-radius: 8px; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; overflow-x: auto; max-height: 500px;">
                    <pre id="remediation-diff" style="margin: 0;"></pre>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeRemediationModal()">Close Preview</button>
            </div>
        </div>
    </div>

    <!-- Progress Modal (Dashboard) -->
    <div id="progress-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; backdrop-filter: blur(4px);">
        <div
            style="background:white; padding:40px; border-radius:16px; width:450px; text-align:center; box-shadow:0 25px 50px rgba(0,0,0,0.25);">
            <h3 id="progress-header" style="margin-bottom:20px; color:#0f172a; font-size:24px; font-weight:700;">
                Analyzing Code...</h3>
            <p id="progress-message" style="color:#64748b; font-size:15px; margin-bottom:30px; font-weight:500;">
                Scanning files...</p>
            <div
                style="width:100%; height:12px; background:#f1f5f9; border-radius:6px; overflow:hidden; border: 1px solid #e2e8f0;">
                <div id="progress-bar-fill"
                    style="height:100%; background:linear-gradient(90deg, #10b981, #34d399); width:0%; transition:width 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);">
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <button class="tab-button active" onclick="switchTab('scan-results')" title="View scan results">üìä Scan
            Results</button>
        <button class="tab-button" onclick="switchTab('projects')" title="View all projects">üóÇÔ∏è Projects</button>
        <button class="tab-button" onclick="switchTab('comparison')" title="Compare projects">üìà Comparison</button>
    </div>

    <!-- Tab 1: Scan Results (Default) -->
    <div id="scan-results" class="tab-content active">
        <div class="metric-card">
            <h3>üîß Scanning Emissions</h3>
            <div class="metric-value">{{ "%.9f"|format(results.get('scanning_emissions', 0)) }}</div>
            <div class="metric-label">kg CO‚ÇÇ</div>
            <p style="font-size: 13px; margin-top: 12px; line-height: 1.5;">Energy used by the analysis tool itself to
                scan your codebase.</p>
        </div>

        <div class="metric-card">
            <h3>‚ö° Codebase Emissions</h3>
            <div class="metric-value">{{ "%.9f"|format(results.get('codebase_emissions', 0)) }}</div>
            <div class="metric-label">kg CO‚ÇÇ Estimated</div>
            <p style="font-size: 13px; margin-top: 12px; line-height: 1.5;">Estimated energy your code would consume if
                executed.</p>
        </div>

        <div class="metric-card">
            <h3>üéØ Issues Found</h3>
            <div class="metric-value">{{ results['issues']|length }}</div>
            <div class="metric-label">Violations Detected</div>
            {% set critical_count = results['issues']|selectattr('severity', 'equalto', 'high')|list|length %}
            {% set medium_count = results['issues']|selectattr('severity', 'equalto', 'medium')|list|length %}
            <p style="font-size: 13px; margin-top: 12px; line-height: 1.5;">
                <span class="severity-badge" style="background: #fee2e2; color: #dc2626;">‚ö†Ô∏è {{ critical_count }}
                    Critical</span>
                <span class="severity-badge" style="background: #fef3c7; color: #d97706;">‚ö†Ô∏è {{ medium_count }}
                    Medium</span>
            </p>
        </div>
    </div>

    <!-- Emissions Analysis -->
    <div class="emissions-comparison">
        <h3>üìä Total Emissions Breakdown</h3>
        {% set total_emissions = results.get('scanning_emissions', 0) + results.get('codebase_emissions', 0) %}
        <p style="font-size: 16px; margin-bottom: 15px;">
            <strong>Total: {{ "%.9f"|format(total_emissions) }} kg CO‚ÇÇ</strong>
        </p>
        {% if total_emissions > 0 %}
        {% set codebase_pct = (results.get('codebase_emissions', 0) / total_emissions) * 100 %}
        {% set scanning_pct = 100 - codebase_pct %}
        <div class="progress-bar">
            <div class="progress-bar-fill"
                style="width: {{ codebase_pct }}%; background: linear-gradient(90deg, #10b981, #059669);">
                {{ "%.1f"|format(codebase_pct) }}% Codebase
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 14px;">
            <div>
                <strong style="color: #10b981;">Codebase:</strong>
                <p>{{ "%.1f"|format(codebase_pct) }}% ({{ "%.9f"|format(results.get('codebase_emissions', 0)) }} kg)</p>
            </div>
            <div>
                <strong style="color: #6b7280;">Scanning:</strong>
                <p>{{ "%.1f"|format(scanning_pct) }}% ({{ "%.9f"|format(results.get('scanning_emissions', 0)) }} kg)</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Per-File Emissions -->
    {% if results.get('per_file_emissions') %}
    <div class="emissions-comparison">
        <h3>üìÅ Top Emitting Files</h3>
        {% set sorted_files = results['per_file_emissions'].items()|sort(attribute='1', reverse=true)|list %}
        {% for file, emissions in sorted_files[:5] %}
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <strong style="word-break: break-all;">{{ file }}</strong>
                <span style="color: #10b981; font-weight: 600;">{{ "%.9f"|format(emissions) }} kg</span>
            </div>
            <div class="progress-bar" style="margin: 0;">
                <div class="progress-bar-fill" style="width: {{ (emissions / sorted_files[0][1] * 100) }}%;"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Runtime Metrics -->
    {% if results.get('runtime_metrics') and results['runtime_metrics'] %}
    <div class="runtime">
        <h3>‚è±Ô∏è Runtime Execution Metrics</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <p><strong>Execution Time:</strong></p>
                <p style="color: #10b981; font-size: 16px; font-weight: 600;">{{
                    results['runtime_metrics'].get('execution_time', 'N/A') }}</p>
            </div>
            <div>
                <p><strong>Runtime Emissions:</strong></p>
                <p style="color: #10b981; font-size: 16px; font-weight: 600;">{{
                    "%.9f"|format(results['runtime_metrics'].get('emissions', 0)) }} kg CO‚ÇÇ</p>
            </div>
            <div>
                <p><strong>Return Code:</strong></p>
                <p style="color: #10b981; font-size: 16px; font-weight: 600;">{{
                    results['runtime_metrics'].get('return_code', 'N/A') }}</p>
            </div>
        </div>
        {% if results['runtime_metrics'].get('output') %}
        <div
            style="margin-top: 15px; background: var(--border-light); padding: 10px; border-radius: 6px; overflow-x: auto;">
            <strong>Output:</strong>
            <pre
                style="margin: 5px 0; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;">{{ results['runtime_metrics']['output'][:500] }}</pre>
        </div>
        {% endif %}
        {% if results['runtime_metrics'].get('error') %}
        <div
            style="margin-top: 15px; background: #fee2e2; padding: 10px; border-left: 4px solid #dc2626; border-radius: 6px;">
            <strong style="color: #dc2626;">Error:</strong>
            <p style="color: #991b1b; margin: 5px 0;">{{ results['runtime_metrics']['error'] }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Issues Section -->
    <div class="issues-container">
        <h3>üéØ Green Code Violations</h3>

        {% if results['issues']|length == 0 %}
        <div class="success-message">
            ‚úì Excellent! No green code violations found. Your code follows sustainable software practices.
        </div>
        {% else %}
        <!-- AI Insights -->
        {% if insights %}
        <div class="insights">
            <h4>üí° AI Insights & Recommendations</h4>
            <ul>
                {% for insight in insights %}
                <li>{{ insight }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Issues List Sorted by Severity -->
        <h4 style="margin-top: 20px; font-size: 16px; font-weight: 600; color: var(--text-light);">Detailed Violations
        </h4>
        {% set sorted_issues = results['issues']|sort(attribute='severity')|reverse|list %}
        {% for issue in sorted_issues %}
        <div class="issue severity-{{ issue.get('severity', 'low') }}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div>
                    <h5 style="margin: 0; font-size: 16px; font-weight: 600;">{{ issue.get('id', 'Unknown') }}</h5>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: #6b7280;">
                        {{ issue.get('file', 'N/A') }}:{{ issue.get('line', '0') }}
                    </p>
                </div>
                <span class="severity-badge" style="margin: 0; 
                        {% if issue.get('severity') == 'high' or issue.get('severity') == 'critical' %}
                            background: #fee2e2; color: #dc2626;
                        {% elif issue.get('severity') == 'medium' %}
                            background: #fef3c7; color: #d97706;
                        {% else %}
                            background: #dbeafe; color: #3b82f6;
                        {% endif %}
                    ">
                    {% if issue.get('severity') == 'high' or issue.get('severity') == 'critical' %}
                    üî¥
                    {% elif issue.get('severity') == 'medium' %}
                    üü°
                    {% else %}
                    üîµ
                    {% endif %}
                    {{ issue.get('severity', 'unknown')|upper }}
                </span>
            </div>

            <p style="margin: 10px 0;"><strong>üìå Issue:</strong> {{ issue.get('message', 'N/A') }}</p>

            <p style="margin: 10px 0;"><strong>‚ö° Impact:</strong> {{ "%.9f"|format(issue.get('codebase_emissions', 0))
                }} kg CO‚ÇÇ</p>

            <p style="margin: 10px 0;"><strong>üîß Fix:</strong> {{ issue.get('remediation', 'N/A') }}</p>
            <button class="btn-small"
                style="margin-top: 10px; background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981;"
                onclick='viewFix({{ results.get('project_name', '') | tojson }}, {{ issue.get('file', '') | tojson }}, {{ issue.get('line', 0) | tojson }}, {{ issue.get('id', '') | tojson }})'>üõ†Ô∏è
                Preview Fix</button>

            {% if issue.get('ai_suggestion') %}
            <p
                style="margin: 10px 0; padding: 10px; background: #ecfdf5; border-left: 3px solid #10b981; border-radius: 4px;">
                <strong>üí° AI Suggestion:</strong><br />{{ issue.get('ai_suggestion', 'N/A') }}
            </p>
            {% endif %}

            <div
                style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                <div style="font-size: 12px; color: #6b7280;">
                    <strong>Effort:</strong> {{ issue.get('effort', 'Unknown') }}
                </div>
                {% if issue.get('tags') %}
                <div style="font-size: 12px;">
                    {% for tag in issue.get('tags', []) %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    </div> <!-- End scan-results tab -->

    <!-- Tab 2: Projects View -->
    <div id="projects" class="tab-content">
        <div class="projects-header">
            <h2 style="font-size: 24px; font-weight: 700; color: var(--text-light); margin: 0;">üìÇ All Projects</h2>
            <div class="search-filter-bar">
                <input type="text" id="search-input" class="search-input" placeholder="Search projects..."
                    onkeyup="filterAndSortProjects()">
                <select id="sort-select" class="sort-select" onchange="filterAndSortProjects()">
                    <option value="name">Sort by Name</option>
                    <option value="violations">Sort by Violations</option>
                    <option value="grade">Sort by Grade</option>
                    <option value="emissions">Sort by Emissions</option>
                    <option value="last_scan">Sort by Last Scan</option>
                </select>
            </div>
        </div>

        <div id="projects-grid" class="projects-grid">
            <p style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 40px 20px;">Loading projects...
            </p>
        </div>
    </div> <!-- End projects tab -->

    <!-- Tab 3: Project Comparison -->
    <div id="comparison" class="tab-content">
        <div style="margin-bottom: 20px;">
            <h2 style="font-size: 24px; font-weight: 700; color: var(--text-light); margin-bottom: 15px;">üìä Project
                Comparison</h2>
            <div class="search-filter-bar">
                <input type="text" id="comparison-projects-input" class="search-input"
                    placeholder="Enter project names separated by comma (e.g., Project1, Project2)...">
                <button onclick="loadComparison()" class="btn-small"
                    style="flex: 0 0 auto; background: var(--primary-color); color: white; border: none; padding: 10px 20px;">Compare</button>
            </div>
        </div>

        <div id="comparison-grid" class="comparison-grid">
            <p style="text-align: center; color: #6b7280; padding: 40px 20px;">Enter project names to compare</p>
        </div>
    </div> <!-- End comparison tab -->

    <script>
        // Security: Escape HTML to prevent XSS
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return String(str).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab and mark button active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for Projects tab
            if (tabName === 'projects') {
                loadProjects();
            }
        }

        // Load projects from API
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();

                if (data.status === 'ok') {
                    displayProjects(data.projects);
                } else {
                    showProjectsError('Failed to load projects');
                }
            } catch (error) {
                showProjectsError('Error loading projects: ' + error.message);
            }
        }

        // Display projects in grid
        function displayProjects(projects) {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = ''; // Clear previous content

            if (projects.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 40px 20px;">No projects found. Create one using the CLI.</p>';
                return;
            }

            projects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.onclick = () => viewProjectDetail(project.name);

                // Header
                const header = document.createElement('div');
                header.className = 'project-card-header';

                const leftDiv = document.createElement('div');
                const nameDiv = document.createElement('div');
                nameDiv.className = 'project-name';
                nameDiv.textContent = project.name;

                const idDiv = document.createElement('div');
                idDiv.style.marginTop = '5px';
                idDiv.style.color = '#6b7280';
                idDiv.style.fontSize = '12px';
                idDiv.textContent = `ID: ${project.id}`;

                leftDiv.appendChild(nameDiv);
                leftDiv.appendChild(idDiv);

                const langDiv = document.createElement('div');
                langDiv.className = 'project-language';
                langDiv.textContent = project.language;

                header.appendChild(leftDiv);
                header.appendChild(langDiv);
                card.appendChild(header);

                // Meta
                const metaDiv = document.createElement('div');
                metaDiv.className = 'project-meta';

                const gradeItem = document.createElement('div');
                gradeItem.className = 'meta-item';
                const gradeLabel = document.createElement('div');
                gradeLabel.className = 'meta-label';
                gradeLabel.textContent = 'Grade';
                const gradeBadge = document.createElement('div');
                gradeBadge.className = `grade-badge grade-${(project.health_grade || '').toLowerCase()}`;
                gradeBadge.textContent = project.health_grade;
                gradeItem.appendChild(gradeLabel);
                gradeItem.appendChild(gradeBadge);
                metaDiv.appendChild(gradeItem);

                const scanItem = document.createElement('div');
                scanItem.className = 'meta-item';
                const scanLabel = document.createElement('div');
                scanLabel.className = 'meta-label';
                scanLabel.textContent = 'Last Scan';
                const scanValue = document.createElement('div');
                scanValue.className = 'meta-value';
                scanValue.textContent = project.last_scan_time || 'Never';
                scanItem.appendChild(scanLabel);
                scanItem.appendChild(scanValue);
                metaDiv.appendChild(scanItem);

                card.appendChild(metaDiv);

                // Violations
                const violationsRow = document.createElement('div');
                violationsRow.className = 'violations-row';

                const createBadge = (count, type, label) => {
                    const badge = document.createElement('div');
                    badge.className = `violation-badge violation-${type}`;
                    const icon = type === 'high' ? 'üî¥' : (type === 'medium' ? 'üü°' : 'üîµ');
                    badge.textContent = `${icon} ${count} ${label}`;
                    return badge;
                };

                violationsRow.appendChild(createBadge(project.high_violations, 'high', 'High'));
                violationsRow.appendChild(createBadge(project.medium_violations, 'medium', 'Medium'));
                violationsRow.appendChild(createBadge(project.low_violations, 'low', 'Low'));

                card.appendChild(violationsRow);

                // Metrics
                const metricsDiv = document.createElement('div');
                metricsDiv.style.margin = '12px 0';
                metricsDiv.style.padding = '12px';
                metricsDiv.style.background = 'var(--border-light)';
                metricsDiv.style.borderRadius = '6px';
                metricsDiv.style.fontSize = '12px';

                const totalDiv = document.createElement('div');
                totalDiv.style.marginBottom = '5px';
                // Using innerHTML with controlled content for <strong> tag
                totalDiv.innerHTML = `<strong>Total Violations:</strong> ${project.violation_count}`;

                const emissionsDiv = document.createElement('div');
                emissionsDiv.innerHTML = `<strong>Emissions:</strong> ${(project.total_emissions * 1e6).toFixed(2)} ¬µg CO‚ÇÇ`;

                metricsDiv.appendChild(totalDiv);
                metricsDiv.appendChild(emissionsDiv);
                card.appendChild(metricsDiv);

                // Footer
                const footerDiv = document.createElement('div');
                footerDiv.style.paddingTop = '12px';
                footerDiv.style.borderTop = '1px solid var(--border-light)';
                footerDiv.style.fontSize = '11px';
                footerDiv.style.color = '#6b7280';
                footerDiv.style.marginTop = '12px';

                footerDiv.appendChild(document.createTextNode(`Created: ${project.created_date || 'N/A'}`));
                footerDiv.appendChild(document.createElement('br'));
                footerDiv.appendChild(document.createTextNode(`URL: ${project.url || 'Local project'}`));

                card.appendChild(footerDiv);

                grid.appendChild(card);
            });
        }

        // Filter and sort projects
        async function filterAndSortProjects() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortBy = document.getElementById('sort-select').value;

            try {
                const response = await fetch('/api/projects');
                const data = await response.json();

                if (data.status === 'ok') {
                    let projects = data.projects;

                    // Filter by search term
                    if (searchTerm) {
                        projects = projects.filter(p =>
                            p.name.toLowerCase().includes(searchTerm) ||
                            p.language.toLowerCase().includes(searchTerm)
                        );
                    }

                    // Sort
                    switch (sortBy) {
                        case 'name':
                            projects.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                        case 'violations':
                            projects.sort((a, b) => b.violation_count - a.violation_count);
                            break;
                        case 'grade':
                            const gradeOrder = { A: 5, B: 4, C: 3, D: 2, F: 1 };
                            projects.sort((a, b) => (gradeOrder[b.health_grade] || 0) - (gradeOrder[a.health_grade] || 0));
                            break;
                        case 'emissions':
                            projects.sort((a, b) => b.total_emissions - a.total_emissions);
                            break;
                        case 'last_scan':
                            projects.sort((a, b) => new Date(b.last_scan_time || 0) - new Date(a.last_scan_time || 0));
                            break;
                    }

                    displayProjects(projects);
                }
            } catch (error) {
                console.error('Error filtering projects:', error);
            }
        }

        // Load comparison data
        async function loadComparison() {
            const input = document.getElementById('comparison-projects-input').value;
            const projectNames = input.split(',').map(name => name.trim()).filter(name => name);

            if (projectNames.length < 2) {
                alert('Please enter at least 2 project names');
                return;
            }

            try {
                const params = new URLSearchParams();
                projectNames.forEach(name => params.append('projects', name));

                const response = await fetch('/api/projects/comparison?' + params);
                const data = await response.json();

                if (data.status === 'ok') {
                    displayComparison(data.projects);
                } else {
                    showComparisonError('No valid projects found');
                }
            } catch (error) {
                showComparisonError('Error loading comparison: ' + error.message);
            }
        }

        // Display comparison
        function displayComparison(projects) {
            const grid = document.getElementById('comparison-grid');

            const metrics = [
                { key: 'health_grade', label: 'Health Grade' },
                { key: 'violation_count', label: 'Total Violations' },
                { key: 'high_violations', label: 'High Violations' },
                { key: 'medium_violations', label: 'Medium Violations' },
                { key: 'low_violations', label: 'Low Violations' },
                { key: 'scanning_emissions', label: 'Scanning Emissions (kg)', format: (v) => (v * 1e6).toFixed(3) + ' ¬µg' },
                { key: 'codebase_emissions', label: 'Codebase Emissions (kg)', format: (v) => (v * 1e6).toFixed(3) + ' ¬µg' },
                { key: 'total_emissions', label: 'Total Emissions (kg)', format: (v) => (v * 1e6).toFixed(3) + ' ¬µg' },
            ];

            let html = '';
            metrics.forEach(metric => {
                let row = '<div class="comparison-row"><div class="comparison-header">' + escapeHTML(metric.label) + '</div>';
                projects.forEach(project => {
                    const value = project[metric.key];
                    const displayValue = metric.format ? metric.format(value) : value;
                    row += '<div class="comparison-value">' + escapeHTML(displayValue) + '</div>';
                });
                row += '</div>';
                html += row;
            });

            grid.innerHTML = html;
        }

        // Show errors
        function showProjectsError(message) {
            document.getElementById('projects-grid').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #dc2626; padding: 40px 20px;">' + escapeHTML(message) + '</p>';
        }

        function showComparisonError(message) {
            document.getElementById('comparison-grid').innerHTML = '<p style="text-align: center; color: #dc2626; padding: 40px 20px;">' + escapeHTML(message) + '</p>';
        }

        function viewProjectDetail(projectName) {
            window.location.href = `/?name=${encodeURIComponent(projectName)}`;
        }

        // ===== PROJECT & SCAN MODAL FUNCTIONS =====

        // Scan Modal Functions
        function openScanModal() {
            document.getElementById('scanModal').classList.add('show');
        }

        function closeScanModal() {
            document.getElementById('scanModal').classList.remove('show');
            document.getElementById('scan-project-name').value = '';
            document.getElementById('scan-url').value = '';
            document.getElementById('scan-path').value = '';
            document.getElementById('scan-branch').value = '';
        }

        function toggleScanMode(mode) {
            const localInput = document.getElementById('local-scan-input');
            const gitInput = document.getElementById('git-scan-input');
            const gitBranchInput = document.getElementById('git-branch-input');
            const modeLocalBtn = document.getElementById('mode-local');
            const modeGitBtn = document.getElementById('mode-git');

            if (mode === 'local') {
                localInput.style.display = 'block';
                gitInput.style.display = 'none';
                gitBranchInput.style.display = 'none';
                modeLocalBtn.style.background = 'var(--primary-color)';
                modeLocalBtn.style.color = 'white';
                modeGitBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                modeGitBtn.style.color = 'inherit';
                document.getElementById('scan-path').required = true;
                document.getElementById('scan-url').required = false;
            } else {
                localInput.style.display = 'none';
                gitInput.style.display = 'block';
                gitBranchInput.style.display = 'block';
                modeLocalBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                modeLocalBtn.style.color = 'inherit';
                modeGitBtn.style.background = 'var(--primary-color)';
                modeGitBtn.style.color = 'white';
                document.getElementById('scan-path').required = false;
                document.getElementById('scan-url').required = true;
            }
        }

        async function submitScan(event) {
            event.preventDefault();

            const projectName = document.getElementById('scan-project-name').value;
            const language = document.getElementById('scan-language').value;
            const gitUrl = document.getElementById('scan-url').value;
            const localPath = document.getElementById('scan-path').value;
            const branch = document.getElementById('scan-branch').value;

            if (!projectName || !language) {
                alert('Please fill in project name and language');
                return;
            }

            if (!gitUrl && !localPath) {
                alert('Please provide either a Git URL or local path');
                return;
            }

            const scanButton = event.target.querySelector('button[type="submit"]');
            const originalText = scanButton.textContent;
            scanButton.disabled = true;
            scanButton.textContent = 'Scanning...';

            try {
                let scanData = {
                    project_name: projectName,
                    language: language
                };

                if (gitUrl) {
                    let urlWithBranch = gitUrl;
                    if (branch) urlWithBranch += '@' + branch;
                    scanData.git_url = urlWithBranch;
                } else {
                    scanData.path = localPath;
                }

                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(scanData)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                alert(`‚úì Scan initiated for ${projectName}\\n\\nType: ${result.scan_type}\\nStatus: ${result.status}`);
                closeScanModal();
                updateCurrentProject(projectName, gitUrl || localPath, language);

                // Refresh projects list
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('Scan error:', error);
                alert(`‚úó Scan failed: ${error.message}`);
            } finally {
                scanButton.disabled = false;
                scanButton.textContent = originalText;
            }
        }

        // Project Modal Functions
        function openProjectList() {
            loadProjectsIntoModal();
            document.getElementById('projectModal').classList.add('show');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
        }

        async function loadProjectsIntoModal() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();

                if (data.status === 'ok' && data.projects.length > 0) {
                    const modalList = document.getElementById('projects-list-modal');
                    modalList.innerHTML = data.projects.map(project => {
                        const safeName = escapeHTML(project.name);
                        const safeUrl = escapeHTML(project.url);
                        const safeGrade = escapeHTML(project.health_grade);
                        const safeLastScan = escapeHTML(project.last_scan_time || 'Never scanned');
                        const safeLanguage = escapeHTML(project.language);

                        // Securely pass strings to onclick by using JSON.stringify and escaping for HTML attribute
                        const onclickArgs = [project.name, project.url, project.health_grade, project.last_scan_time]
                            .map(arg => escapeHTML(JSON.stringify(arg || '')))
                            .join(', ');

                        return `
                        <div style="padding: 12px; background: var(--bg-light); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s;" 
                             onmouseover="this.style.background='var(--border-light)'" 
                             onmouseout="this.style.background='var(--bg-light)'"
                             onclick='selectProject(${onclickArgs})'>
                            <div style="font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                                <span>${safeName}</span>
                                <span style="font-size: 20px; font-weight: 700; color: #10b981;">${safeGrade}</span>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${safeLanguage} ‚Ä¢ ${project.violation_count} violations ‚Ä¢ ${safeLastScan}
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('projects-list-modal').innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px 20px;">No projects found. Create one with the New Scan button.</p>';
                }
            } catch (error) {
                document.getElementById('projects-list-modal').innerHTML = '<p style="text-align: center; color: #dc2626; padding: 40px 20px;">Error loading projects: ' + escapeHTML(error.message) + '</p>';
            }
        }

        function selectProject(name, url, grade, lastScan) {
            updateCurrentProject(name, url, grade, lastScan);
            closeProjectModal();
        }

        function updateCurrentProject(name, url, gradeOrLanguage, lastScanTime) {
            document.getElementById('current-project-name').textContent = name || 'Local Scan';
            document.getElementById('current-project-url').textContent = url || 'No project selected';

            if (lastScanTime) {
                document.getElementById('current-project-time').textContent = lastScanTime;
            }

            if (gradeOrLanguage && gradeOrLanguage.length === 1) {
                // It's a grade
                const gradeIcon = gradeOrLanguage === 'A' ? '‚úÖ' : gradeOrLanguage === 'B' ? 'üëç' : gradeOrLanguage === 'C' ? '‚ö†Ô∏è' : gradeOrLanguage === 'D' ? 'üî∂' : '‚ùå';
                document.getElementById('current-project-grade-icon').textContent = gradeIcon;
                document.getElementById('current-project-grade').textContent = 'Grade: ' + gradeOrLanguage;
            }
        }

        function refreshCurrentProject() {
            alert('Refreshing project data...\\n\\nThis will reload the current project\\'s scan results and metrics.');
            location.reload();
        }

        async function calibrateSystem() {
            if (!confirm('Run system calibration benchmarks?\\n\\nThis will take a few seconds and measure your CPU/Memory performance to normalize carbon emission estimates.')) {
                return;
            }

            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Running...';
                btn.disabled = true;

                const response = await fetch('/api/calibrate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    const profile = data.profile;
                    const msg = `‚úì Calibration Complete!\\n\\n` +
                                `Platform: ${profile.platform}\\n` +
                                `CPU Multiplier: ${profile.coefficients.cpu_multiplier}x\\n` +
                                `Efficiency Tier: ${profile.coefficients.efficiency_tier}\\n\\n` +
                                `Carbon emission estimates will now be adjusted based on this profile.`;
                    alert(msg);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to calibrate: ' + error.message);
            } finally {
                location.reload();
            }
        }

        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Project Management Functions
        async function deleteProject(projectName) {
            if (!confirm(`Are you sure you want to delete project "${projectName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${encodeURIComponent(projectName)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Failed to delete: ${response.status}`);

                alert(`‚úì Project "${projectName}" deleted successfully`);
                setTimeout(() => location.reload(), 500);
            } catch (error) {
                console.error('Delete error:', error);
                alert(`‚úó Failed to delete project: ${error.message}`);
            }
        }

        async function rescanProject(projectName) {
            if (!confirm(`Rescan project "${projectName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${encodeURIComponent(projectName)}/rescan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Failed to rescan: ${response.status}`);

                const result = await response.json();
                alert(`‚úì Rescan initiated for "${projectName}"`);
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('Rescan error:', error);
                alert(`‚úó Failed to rescan project: ${error.message}`);
            }
        }

        async function clearProject(projectName) {
            if (!confirm(`Clear all violations and scan data for "${projectName}"?\\n\\nThis will prepare the project for a fresh scan.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${encodeURIComponent(projectName)}/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Failed to clear: ${response.status}`);

                const result = await response.json();
                alert(`‚úì Project "${projectName}" cleared and ready for fresh scan`);
                setTimeout(() => location.reload(), 500);
            } catch (error) {
                console.error('Clear error:', error);
                alert(`‚úó Failed to clear project: ${error.message}`);
            }
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            const btn = document.querySelector('.theme-toggle');
            if (btn) btn.textContent = '‚òÄÔ∏è';
        }

        async function viewFix(project, file, line, issueId) {
            const modal = document.getElementById('remediationModal');
            const diffEl = document.getElementById('remediation-diff');
            const descEl = document.getElementById('remediation-desc');

            diffEl.innerText = "Generating remediation preview...";
            descEl.innerText = "";
            modal.style.display = 'flex';

            try {
                const response = await fetch(`/api/remediation/preview?project=${encodeURIComponent(project)}&file=${encodeURIComponent(file)}&line=${line}&issue_id=${encodeURIComponent(issueId)}`);
                const data = await response.json();

                if (data.status === 'ok') {
                    diffEl.innerText = data.diff || "No changes suggested for this issue.";
                    descEl.innerText = data.description;
                } else {
                    diffEl.innerText = "Error: " + data.error;
                }
            } catch (error) {
                diffEl.innerText = "Failed to fetch remediation: " + error.message;
            }
        }

        function closeRemediationModal() {
            document.getElementById('remediationModal').style.display = 'none';
        }

        // --- Socket.IO Progress Logic ---
        const socket = io();
        socket.on('scan_progress', (data) => {
            const modal = document.getElementById('progress-modal');
            const msg = document.getElementById('progress-message');
            const fill = document.getElementById('progress-bar-fill');
            if (modal) modal.style.display = 'flex';
            if (msg) msg.innerText = data.message;
            if (fill) fill.style.width = data.percentage + '%';
        });
        socket.on('scan_finished', (data) => {
            const header = document.getElementById('progress-header');
            if (header) header.innerText = 'Scan Complete!';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        });
        socket.on('scan_error', (data) => {
            alert('Scan Error: ' + data.error);
            const modal = document.getElementById('progress-modal');
            if (modal) modal.style.display = 'none';
        });
    </script>
</body>

</html>